<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test App - shru-design-system</title>
    <script>/**
 * Synchronous theme application script
 * This script runs before React to prevent theme flash
 * Injected automatically by init script
 */

(function() {
  'use strict';
  
  if (typeof window === 'undefined' || typeof document === 'undefined') {
    return;
  }

  const STORAGE_KEY = 'design-system-theme';
  
  // Default themes
  const defaultThemes = {
    color: 'white',
    typography: 'sans',
    shape: 'smooth',
    density: 'comfortable',
    animation: 'gentle'
  };

  // Get theme from localStorage
  let selectedThemes = defaultThemes;
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      selectedThemes = JSON.parse(stored);
    }
  } catch (e) {
    // Use defaults if parse fails
  }

  // Helper functions
  function isObject(item) {
    return item && typeof item === 'object' && !Array.isArray(item);
  }

  function deepMerge(target, source) {
    const output = Object.assign({}, target);
    if (isObject(target) && isObject(source)) {
      Object.keys(source).forEach(function(key) {
        if (isObject(source[key])) {
          if (!(key in target)) {
            Object.assign(output, { [key]: source[key] });
          } else {
            output[key] = deepMerge(target[key], source[key]);
          }
        } else {
          Object.assign(output, { [key]: source[key] });
        }
      });
    }
    return output;
  }

  function loadJSONSync(path) {
    try {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', path, false); // Synchronous
      xhr.send(null);
      if (xhr.status === 200 || xhr.status === 0) {
        return JSON.parse(xhr.responseText);
      }
    } catch (e) {
      // Return null if fails
    }
    return null;
  }

  function resolveReferences(tokens, palette) {
    var resolved = JSON.parse(JSON.stringify(tokens));
    
    function resolveValue(value) {
      if (typeof value !== 'string') return value;
      var match = value.match(/^\{([^}]+)\}$/);
      if (!match) return value;
      var path = match[1].split('.');
      var current = Object.assign({}, { palette: palette }, resolved);
      for (var i = 0; i < path.length; i++) {
        var key = path[i];
        if (current && typeof current === 'object' && key in current) {
          current = current[key];
        } else {
          return value;
        }
      }
      return typeof current === 'string' ? current : value;
    }
    
    function traverse(obj) {
      for (var key in obj) {
        if (typeof obj[key] === 'object' && obj[key] !== null) {
          traverse(obj[key]);
        } else {
          obj[key] = resolveValue(obj[key]);
        }
      }
    }
    
    traverse(resolved);
    return resolved;
  }

  function flattenToCSS(tokens, prefix, result, isColorContext) {
    prefix = prefix || '';
    result = result || {};
    isColorContext = isColorContext || false;
    
    for (var key in tokens) {
      var value = tokens[key];
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        var enteringColor = key === 'color' && prefix === '';
        var inColorContext = isColorContext || enteringColor;
        if (enteringColor) {
          flattenToCSS(value, '', result, true);
        } else if (inColorContext) {
          flattenToCSS(value, '', result, true);
        } else {
          var newPrefix = prefix ? prefix + '-' + key : key;
          flattenToCSS(value, newPrefix, result, false);
        }
      } else {
        var cssKey;
        if (isColorContext || (prefix === '' && key === 'color')) {
          cssKey = '--' + key;
        } else if (prefix === '') {
          cssKey = '--' + key;
        } else {
          cssKey = '--' + prefix + '-' + key;
        }
        result[cssKey] = value;
      }
    }
    return result;
  }

  function mapToTailwindVars(cssVars) {
    var mapped = Object.assign({}, cssVars);
    if (cssVars['--radius-button']) {
      mapped['--radius'] = cssVars['--radius-button'];
    }
    if (cssVars['--radius-card']) {
      mapped['--radius-lg'] = cssVars['--radius-card'];
    }
    if (cssVars['--font-body']) {
      mapped['--font-sans'] = cssVars['--font-body'];
    }
    if (cssVars['--spacing-base']) {
      mapped['--spacing'] = cssVars['--spacing-base'];
    } else if (cssVars['--spacing-component-md']) {
      mapped['--spacing'] = cssVars['--spacing-component-md'];
    }
    return mapped;
  }

  // Apply theme synchronously
  try {
    var base = loadJSONSync('/tokens/base.json');
    var palettes = loadJSONSync('/tokens/palettes.json');
    var palette = (palettes && palettes.palette) || {};

    if (!base) {
      return; // Can't proceed without base tokens
    }

    // Merge base with palette
    var merged = deepMerge(base, { palette: palette });

    // Load theme files
    var categoryOrder = ['color', 'typography', 'shape', 'density', 'animation'];
    for (var i = 0; i < categoryOrder.length; i++) {
      var category = categoryOrder[i];
      var themeId = selectedThemes[category];
      if (!themeId) continue;

      try {
        var themeData = loadJSONSync('/tokens/themes/' + category + '/' + themeId + '.json');
        if (themeData) {
          merged = deepMerge(merged, themeData);
        }
      } catch (e) {
        // Skip if theme file doesn't exist
      }
    }

    // Handle custom theme
    if (selectedThemes.custom) {
      try {
        var customData = loadJSONSync('/tokens/themes/custom/' + selectedThemes.custom + '.json');
        if (customData) {
          merged = deepMerge(merged, customData);
        }
      } catch (e) {
        // Skip if custom theme doesn't exist
      }
    }

    // Resolve references
    var resolved = resolveReferences(merged, palette);

    // Flatten to CSS variables
    var cssVars = flattenToCSS(resolved);

    // Map to Tailwind-compatible variables
    var mappedVars = mapToTailwindVars(cssVars);

    // Generate CSS
    var cssVarsArray = [];
    for (var key in mappedVars) {
      cssVarsArray.push('  ' + key + ': ' + mappedVars[key] + ';');
    }
    var css = ':root {\n' + cssVarsArray.join('\n') + '\n}';

    // Apply to DOM
    var styleTag = document.getElementById('dynamic-theme');
    if (!styleTag) {
      styleTag = document.createElement('style');
      styleTag.id = 'dynamic-theme';
      document.head.insertBefore(styleTag, document.head.firstChild);
    }
    styleTag.textContent = css;
  } catch (error) {
    // Silently fail - theme will apply via React hook
    console.warn('Sync theme application failed, will apply via React:', error);
  }
})();

</script>
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

